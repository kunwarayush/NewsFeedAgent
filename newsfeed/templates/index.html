<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>News Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>
        body { background:#f5f5f5; }
        .controls { margin-top:20px; }
        .scores span { margin-right:8px; font-size:0.85em; }
    </style>
</head>
<body>
<nav class="blue darken-2">
  <div class="nav-wrapper container">
    <a href="#" class="brand-logo">News Dashboard</a>
  </div>
</nav>
<div class="container">
  <div class="row controls">
    <div class="input-field col s3">
      <input id="limit" type="number" min="20" max="100" value="20">
      <label for="limit">Stories</label>
    </div>
    <div class="input-field col s3">
      <select id="sort">
        <option value="latest" selected>Latest</option>
        <option value="trending">Trending</option>
        <option value="top">Top</option>
        <option value="oldest">Oldest</option>
      </select>
      <label>Sort</label>
    </div>
    <div class="input-field col s3">
      <a id="refresh" class="btn">Refresh</a>
    </div>
  </div>
  <div id="stories" class="row"></div>
  <div class="row center">
    <a id="loadMore" class="btn grey lighten-1 black-text">Load More</a>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var elems = document.querySelectorAll('select');
    M.FormSelect.init(elems);
    loadStories(true);
});

let offset = 0;
async function loadStories(reset=false){
    const limit = parseInt(document.getElementById('limit').value)||20;
    const sort = document.getElementById('sort').value;
    const res = await fetch(`/stories?limit=${limit}&sort=${sort}&offset=${reset?0:offset}`);
    const data = await res.json();
    if(reset){
        document.getElementById('stories').innerHTML='';
        offset = 0;
    }
    data.forEach(st => {
        const col = document.createElement('div');
        col.className = 'col s12 m6';
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
        <div class="card-content">
          <span class="card-title"><a href="${st.link}" target="_blank">${st.title}</a></span>
          <p class="grey-text text-darken-1">${st.source ? `Source: ${st.source} â€” ` : ''}Category: ${st.category}</p>
          <p>${st.summary || ''}</p>
          <p class="scores">
            <span title="${st.relevance_expl}">Rel: ${st.relevance.toFixed(2)}</span>
            <span title="${st.bias_expl}">Bias: ${st.bias.toFixed(2)}</span>
            <span title="${st.trending_expl}">Trend: ${st.trending.toFixed(2)}</span>
          </p>
        </div>
        <div class="card-action">
          <ul class="collapsible">
            <li>
              <div class="collapsible-header">Data Points</div>
              <div class="collapsible-body"><ul>${st.stats.map(s=>`<li>${s}</li>`).join('')}</ul></div>
            </li>
            <li>
              <div class="collapsible-header">Perspectives</div>
              <div class="collapsible-body"><ul>${st.perspectives.map(p=>`<li><strong>${p.label}:</strong> ${p.text}</li>`).join('')}</ul></div>
            </li>
            <li>
              <div class="collapsible-header">References</div>
              <div class="collapsible-body"><ul>${st.references.map(r=>`<li><a href="${r.link}" target="_blank">${r.title}</a></li>`).join('')}</ul></div>
            </li>
          </ul>
        </div>`;
        col.appendChild(card);
        document.getElementById('stories').appendChild(col);
        M.Collapsible.init(card.querySelectorAll('.collapsible'));
    });
    offset += data.length;
}

document.getElementById('refresh').addEventListener('click', ()=>loadStories(true));
document.getElementById('loadMore').addEventListener('click', ()=>loadStories());
</script>
</body>
</html>
